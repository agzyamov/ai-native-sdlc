name: Terraform Security Validation

on:
  pull_request:
    paths:
      - 'infra/**'
      - '.github/workflows/terraform-validate.yml'
  push:
    branches: [main]
    paths:
      - 'infra/**'

jobs:
  security-policy-check:
    name: Security Policy Validation
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: infra
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.0"
      
      - name: Check for public access violations
        run: |
          echo "ðŸ” Checking for public access violations..."
          
          # Check if enable_public_access is set to true anywhere
          if grep -r "enable_public_access.*=.*true" . --include="*.tf" --include="*.tfvars"; then
            echo "âŒ SECURITY VIOLATION: enable_public_access is set to true"
            echo "This violates the security policy: NO public internet access allowed"
            exit 1
          fi
          
          # Check if Consumption plan (Y1) is used
          if grep -r 'sku_name.*=.*"Y1"' . --include="*.tf" --include="*.tfvars"; then
            echo "âŒ SECURITY VIOLATION: Consumption plan (Y1) detected"
            echo "Consumption plan does NOT support network isolation"
            echo "Use Premium plan (EP1/EP2/EP3) instead"
            exit 1
          fi
          
          # Verify network security is properly configured
          echo "âœ… Checking network security configuration..."
          
          # Storage Account must have network_rules with default_action = Deny
          if ! grep -A20 "azurerm_storage_account" *.tf | grep -q "default_action.*=.*\"Deny\""; then
            echo "âŒ SECURITY VIOLATION: Storage account missing network_rules with default_action = Deny"
            exit 1
          fi
          echo "  âœ“ Storage account has network_rules with default Deny"
          
          # Key Vault must have network_acls
          if ! grep -A15 "azurerm_key_vault" *.tf | grep -q "network_acls"; then
            echo "âŒ SECURITY VIOLATION: Key Vault missing network_acls"
            exit 1
          fi
          echo "  âœ“ Key Vault has network_acls"
          
          # Function App must have IP restrictions with default deny
          if ! grep -A20 "azurerm_linux_function_app" *.tf | grep -q "ip_restriction_default_action.*=.*\"Deny\""; then
            echo "âŒ SECURITY VIOLATION: Function App must have ip_restriction_default_action = Deny"
            exit 1
          fi
          echo "  âœ“ Function App has IP restrictions with default Deny"
          
          echo ""
          echo "âœ… Security policy validation passed - network isolation properly configured"
      
      - name: Terraform Init
        run: terraform init -backend=false
      
      - name: Terraform Validate
        run: terraform validate
      
      - name: Terraform Format Check
        run: terraform fmt -check -recursive
      
      - name: Security Policy Summary
        run: |
          {
            echo "## Security Policy Compliance âœ…"
            echo ""
            echo "- âœ… No public internet access enabled"
            echo "- âœ… Premium plan enforced (no Consumption Y1)"
            echo "- âœ… VNet integration required"
            echo "- âœ… Private endpoints configured"
          } >> "$GITHUB_STEP_SUMMARY"
