name: Spec Kit - Generate Checklist

on:
  workflow_dispatch:
    inputs:
      spec_path:
        description: 'Path to spec file (e.g., specs/001-feature-name/spec.md)'
        required: true
        type: string
      branch_name:
        description: 'Branch name (optional, defaults to current branch)'
        required: false
        type: string
  workflow_call:
    inputs:
      spec_path:
        description: 'Path to spec file'
        required: true
        type: string
      branch_name:
        description: 'Branch name'
        required: true
        type: string

jobs:
  generate-checklist:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch_name || github.ref }}

      - name: Generate Quality Checklist
        run: |
          SPEC_FILE="${{ inputs.spec_path }}"
          BRANCH_NAME="${{ inputs.branch_name || github.ref_name }}"

          if [ ! -f "$SPEC_FILE" ]; then
            echo "âŒ ERROR: Spec file not found: $SPEC_FILE"
            exit 1
          fi

          echo "ðŸ“‹ Generating quality checklist for: $SPEC_FILE"
          echo "Branch: $BRANCH_NAME"

          # Extract feature directory from spec file path
          SPEC_DIR=$(dirname "$SPEC_FILE")
          CHECKLIST_DIR="$SPEC_DIR/checklists"
          CHECKLIST_FILE="$CHECKLIST_DIR/requirements.md"

          # Create checklists directory
          mkdir -p "$CHECKLIST_DIR"

          # Extract feature name from spec
          FEATURE_NAME=$(grep "^# Feature Specification:" "$SPEC_FILE" | sed 's/# Feature Specification: //' || echo "Feature")

          # Count [NEEDS CLARIFICATION] markers in spec
          CLARIFICATION_COUNT=$(grep -c "\[NEEDS CLARIFICATION" "$SPEC_FILE" || echo "0")

          # Create checklist with template
          CURRENT_DATE=$(date +%Y-%m-%d)
          {
            echo "# Specification Quality Checklist: $FEATURE_NAME"
            echo ""
            echo "Purpose - Validate specification completeness and quality before proceeding to planning"
            echo "Created - $CURRENT_DATE"
            echo "Feature - [../spec.md](../spec.md)"
            echo ""
            echo "## Content Quality"
            echo ""
            echo "- [ ] No implementation details (languages, frameworks, APIs)"
            echo "- [ ] Focused on user value and business needs"
            echo "- [ ] Written for non-technical stakeholders"
            echo "- [ ] All mandatory sections completed"
            echo ""
            echo "## Requirement Completeness"
            echo ""
            echo "- [ ] No [NEEDS CLARIFICATION] markers remain"
            echo "- [ ] Requirements are testable and unambiguous"
            echo "- [ ] Success criteria are measurable"
            echo "- [ ] Success criteria are technology-agnostic (no implementation details)"
            echo "- [ ] All acceptance scenarios are defined"
            echo "- [ ] Edge cases are identified"
            echo "- [ ] Scope is clearly bounded"
            echo "- [ ] Dependencies and assumptions identified"
            echo ""
            echo "## Feature Readiness"
            echo ""
            echo "- [ ] All functional requirements have clear acceptance criteria"
            echo "- [ ] User scenarios cover primary flows"
            echo "- [ ] Feature meets measurable outcomes defined in Success Criteria"
            echo "- [ ] No implementation details leak into specification"
            echo ""
            echo "## Clarifications Needed"
            echo ""
          } > "$CHECKLIST_FILE"

          # Add clarifications section
          if [ "$CLARIFICATION_COUNT" -gt 0 ]; then
            {
              echo ""
              echo "âš ï¸ **$CLARIFICATION_COUNT clarification(s) found in specification**"
              echo ""
              echo "The following items need clarification:"
              echo ""
            } >> "$CHECKLIST_FILE"

            # Extract all NEEDS CLARIFICATION markers with context
            grep -n "\[NEEDS CLARIFICATION" "$SPEC_FILE" | while IFS=: read -r line_num content; do
              clarification=$(echo "$content" | sed 's/.*\[NEEDS CLARIFICATION: \(.*\)\].*/\1/')
              echo "- **Line $line_num**: $clarification" >> "$CHECKLIST_FILE"
            done

            {
              echo ""
              echo "**Action Required**: Address these clarifications before proceeding to \`/speckit.plan\`"
            } >> "$CHECKLIST_FILE"
          else
            {
              echo ""
              echo "âœ… **No clarifications needed** - specification is complete and ready for planning"
            } >> "$CHECKLIST_FILE"
          fi

          # Add notes section
          {
            echo ""
            echo "## Validation Notes"
            echo ""
            echo "This checklist was auto-generated. Review each item and check off as validated."
            echo ""
            echo "### Next Steps"
            echo ""
            echo "1. Review specification for completeness"
            echo "2. Address any clarifications marked above"
            echo "3. Check off all validation items"
            echo "4. Proceed to \`/speckit.plan\` when ready"
            echo ""
          } >> "$CHECKLIST_FILE"

          echo ""
          echo "âœ… Checklist created at: $CHECKLIST_FILE"
          echo ""
          echo "Preview:"
          head -50 "$CHECKLIST_FILE"

      - name: Commit Checklist
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          SPEC_FILE="${{ inputs.spec_path }}"
          SPEC_DIR=$(dirname "$SPEC_FILE")
          CHECKLIST_FILE="$SPEC_DIR/checklists/requirements.md"

          git add "$CHECKLIST_FILE"

          if git diff --staged --quiet; then
            echo "âš ï¸ No changes to commit"
          else
            git commit -m "chore: add quality checklist for specification" \
              -m "Spec: $SPEC_FILE" \
              -m "Generated by spec-kit-checklist workflow"

            git push origin HEAD

            echo "âœ… Checklist committed and pushed"
          fi

      - name: Summary
        if: always()
        run: |
          SPEC_FILE="${{ inputs.spec_path }}"
          SPEC_DIR=$(dirname "$SPEC_FILE")
          CHECKLIST_FILE="$SPEC_DIR/checklists/requirements.md"

          echo "## ðŸ“‹ Spec Kit - Quality Checklist Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Spec File:** \`$SPEC_FILE\`" >> $GITHUB_STEP_SUMMARY
          echo "**Checklist:** \`$CHECKLIST_FILE\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ inputs.branch_name || github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "$CHECKLIST_FILE" ]; then
            CLARIFICATION_COUNT=$(grep -c "\[NEEDS CLARIFICATION" "$SPEC_FILE" || echo "0")
            echo "### ðŸ“Š Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Clarifications Found:** $CLARIFICATION_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ "$CLARIFICATION_COUNT" -gt 0 ]; then
              echo "âš ï¸ **Action Required:** Review and address clarifications in the checklist" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… **Specification is complete** - ready for planning phase" >> $GITHUB_STEP_SUMMARY
            fi
          fi
