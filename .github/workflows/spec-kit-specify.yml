name: Spec Kit - Specify Feature

on:
  workflow_dispatch:
    inputs:
      feature_description:
        description: 'Feature description (what to build)'
        required: true
        type: string
      create_branch:
        description: 'Create feature branch automatically'
        required: false
        type: boolean
        default: true

jobs:
  specify-feature:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
      
      - name: Setup Python for Spec Kit
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install uv and Specify CLI
        run: |
          echo "ðŸ“¦ Installing uv package manager..."
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          
          echo "ðŸ“¦ Installing Specify CLI..."
          export PATH="$HOME/.cargo/bin:$PATH"
          uv tool install specify-cli --from git+https://github.com/github/spec-kit.git
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          
          echo "âœ… Specify CLI installed"
      
      - name: Install GitHub Copilot CLI
        run: |
          echo "ðŸ“¦ Installing GitHub Copilot CLI..."
          npm install -g @github/copilot
          npx @github/copilot --version
          echo "âœ… Copilot CLI installed"
      
      - name: Verify Spec Kit prompts
        run: |
          echo "ðŸ” Checking for Spec Kit prompts..."
          if [ ! -d ".github/prompts" ]; then
            echo "âŒ ERROR: Spec Kit not initialized!"
            echo "Please run 'spec-kit-init.yml' workflow first"
            exit 1
          fi
          
          if [ ! -f ".github/prompts/speckit.specify.prompt.md" ]; then
            echo "âŒ ERROR: speckit.specify.prompt.md not found!"
            exit 1
          fi
          
          echo "âœ… Spec Kit prompts found"
          ls -la .github/prompts/speckit.*.prompt.md
      
      - name: Run /speckit.specify with Copilot
        env:
          GITHUB_TOKEN: ${{ secrets.COPILOT_TOKEN || secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.COPILOT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          export GITHUB_TOKEN="${GITHUB_TOKEN}"
          export GH_TOKEN="${GH_TOKEN}"
          export PATH="$HOME/.local/bin:$HOME/.cargo/bin:$PATH"
          
          if [ -z "$GITHUB_TOKEN" ]; then
            echo "âŒ ERROR: No authentication token found!"
            exit 1
          fi
          
          echo "ðŸ¤– Running /speckit.specify with Copilot..."
          echo ""
          echo "Feature Description: ${{ github.event.inputs.feature_description }}"
          echo ""
          
          # Create the full prompt for Copilot
          echo "You are a GitHub Copilot agent with access to Spec Kit." > prompt.txt
          echo "" >> prompt.txt
          cat .github/prompts/speckit.specify.prompt.md >> prompt.txt
          echo "" >> prompt.txt
          echo "FEATURE DESCRIPTION:" >> prompt.txt
          echo "${{ github.event.inputs.feature_description }}" >> prompt.txt
          echo "" >> prompt.txt
          echo "Execute the /speckit.specify workflow:" >> prompt.txt
          echo "1. Generate a concise short name (2-4 words) for the branch" >> prompt.txt
          echo "2. Create the feature specification file" >> prompt.txt
          echo "3. Output the branch name and file path" >> prompt.txt
          echo "4. Save the spec to the appropriate location" >> prompt.txt
          echo "" >> prompt.txt
          echo "Return ONLY:" >> prompt.txt
          echo "- Branch name (short-name format)" >> prompt.txt
          echo "- Spec file path" >> prompt.txt
          echo "- Brief summary of what was created" >> prompt.txt
          
          # Run Copilot with the prompt
          cat prompt.txt | GITHUB_TOKEN="${GITHUB_TOKEN}" GH_TOKEN="${GH_TOKEN}" npx @github/copilot \
            --allow-all-tools \
            --allow-all-paths \
            -p - \
            2>&1 | tee copilot_output.txt
          
          echo ""
          echo "âœ… /speckit.specify completed"
      
      - name: Parse Copilot Output
        id: parse
        run: |
          echo "ðŸ“ Parsing Copilot output..."
          
          # Extract branch name and spec file from output
          # This is a simple parser - Copilot should output in a structured format
          BRANCH_NAME=$(grep -oP "Branch.*?:\s*\K[\w-]+" copilot_output.txt || echo "feature/new-feature")
          SPEC_FILE=$(grep -oP "Spec.*?:\s*\K[^\s]+" copilot_output.txt || echo "")
          
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "spec_file=$SPEC_FILE" >> $GITHUB_OUTPUT
          
          echo "Detected branch: $BRANCH_NAME"
          echo "Detected spec file: $SPEC_FILE"
      
      - name: Create Feature Branch
        if: github.event.inputs.create_branch == 'true'
        run: |
          BRANCH_NAME="${{ steps.parse.outputs.branch_name }}"
          
          echo "ðŸŒ± Creating feature branch: $BRANCH_NAME"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Check if branch already exists
          if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
            echo "âš ï¸ Branch $BRANCH_NAME already exists, checking it out"
            git fetch origin "$BRANCH_NAME"
            git checkout "$BRANCH_NAME"
          else
            echo "âœ¨ Creating new branch $BRANCH_NAME"
            git checkout -b "$BRANCH_NAME"
          fi
      
      - name: Commit and Push Spec
        if: github.event.inputs.create_branch == 'true'
        run: |
          BRANCH_NAME="${{ steps.parse.outputs.branch_name }}"
          SPEC_FILE="${{ steps.parse.outputs.spec_file }}"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Add all generated files (specs, plans, etc.)
          git add -A
          
          if git diff --staged --quiet; then
            echo "âš ï¸ No changes to commit"
          else
            echo "ðŸ’¾ Committing specification..."
            git commit -m "feat: add feature specification" \
              -m "Feature: ${{ github.event.inputs.feature_description }}" \
              -m "Generated by /speckit.specify workflow"
            
            echo "ðŸ“¤ Pushing to branch: $BRANCH_NAME"
            git push origin "$BRANCH_NAME"
            
            echo "âœ… Spec committed and pushed to $BRANCH_NAME"
          fi
      
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: spec-kit-output
          path: |
            copilot_output.txt
            specs/
            .specify/
          retention-days: 30
      
      - name: Summary
        if: always()
        run: |
          BRANCH_NAME="${{ steps.parse.outputs.branch_name }}"
          SPEC_FILE="${{ steps.parse.outputs.spec_file }}"
          
          echo "## ðŸ“‹ Spec Kit - Specify Feature" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Feature:** ${{ github.event.inputs.feature_description }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`$BRANCH_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Spec File:** \`$SPEC_FILE\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“– Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the generated specification" >> $GITHUB_STEP_SUMMARY
          echo "2. Run \`/speckit.plan\` to create technical implementation plan" >> $GITHUB_STEP_SUMMARY
          echo "3. Run \`/speckit.tasks\` to generate actionable task lists" >> $GITHUB_STEP_SUMMARY
          echo "4. Run \`/speckit.implement\` to execute all tasks" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Resources" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [View Branch](https://github.com/${{ github.repository }}/tree/$BRANCH_NAME)" >> $GITHUB_STEP_SUMMARY
          echo "- [Spec Kit Documentation](https://github.github.io/spec-kit/)" >> $GITHUB_STEP_SUMMARY

