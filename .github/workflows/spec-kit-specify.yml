name: Spec Kit - Specify Feature

on:
  workflow_dispatch:
    inputs:
      feature_description:
        description: 'Feature description (what to build)'
        required: true
        type: string
      create_branch:
        description: 'Create feature branch automatically'
        required: false
        type: boolean
        default: true

jobs:
  specify-feature:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
      
      - name: Setup Python for Spec Kit
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install uv and Specify CLI
        run: |
          echo "üì¶ Installing uv package manager..."
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          
          echo "üì¶ Installing Specify CLI..."
          export PATH="$HOME/.cargo/bin:$PATH"
          uv tool install specify-cli --from git+https://github.com/github/spec-kit.git
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          
          echo "‚úÖ Specify CLI installed"
      
      - name: Install GitHub Copilot CLI
        run: |
          echo "üì¶ Installing GitHub Copilot CLI..."
          npm install -g @github/copilot
          npx @github/copilot --version
          echo "‚úÖ Copilot CLI installed"
      
      - name: Verify Spec Kit prompts
        run: |
          echo "üîç Checking for Spec Kit prompts..."
          if [ ! -d ".github/prompts" ]; then
            echo "‚ùå ERROR: Spec Kit not initialized!"
            echo "Please run 'spec-kit-init.yml' workflow first"
            exit 1
          fi
          
          if [ ! -f ".github/prompts/speckit.specify.prompt.md" ]; then
            echo "‚ùå ERROR: speckit.specify.prompt.md not found!"
            exit 1
          fi
          
          echo "‚úÖ Spec Kit prompts found"
          ls -la .github/prompts/speckit.*.prompt.md
      
      - name: Step 1 - Generate Short Name with Copilot
        id: generate_name
        env:
          GITHUB_TOKEN: ${{ secrets.COPILOT_TOKEN || secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.COPILOT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          export GITHUB_TOKEN="${GITHUB_TOKEN}"
          export GH_TOKEN="${GH_TOKEN}"
          
          if [ -z "$GITHUB_TOKEN" ]; then
            echo "‚ùå ERROR: No authentication token found!"
            exit 1
          fi
          
          echo "ü§ñ Step 1: Generating short branch name..."
          echo ""
          echo "Feature: ${{ github.event.inputs.feature_description }}"
          echo ""
          
          # Ask Copilot directly with compact prompt
          npx @github/copilot --allow-all-tools -p "Generate a 2-4 word kebab-case branch name for: ${{ github.event.inputs.feature_description }}. Respond with ONLY the branch name." 2>&1 | tee short_name_output.txt
          
          # Extract the short name (first non-empty line before statistics)
          SHORT_NAME=$(head -1 short_name_output.txt | tr -d '`' | xargs)
          
          echo "Generated short name: $SHORT_NAME"
          echo "short_name=$SHORT_NAME" >> $GITHUB_OUTPUT
      
      - name: Step 2 - Run create-new-feature script
        id: create_feature
        run: |
          export PATH="$HOME/.local/bin:$HOME/.cargo/bin:$PATH"
          
          SHORT_NAME="${{ steps.generate_name.outputs.short_name }}"
          FEATURE_DESC="${{ github.event.inputs.feature_description }}"
          
          echo "üå± Step 2: Running create-new-feature.sh script..."
          echo "Short name: $SHORT_NAME"
          echo "Description: $FEATURE_DESC"
          echo ""
          
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Run the script with --json flag
          cd "$GITHUB_WORKSPACE"
          .specify/scripts/bash/create-new-feature.sh --json --short-name "$SHORT_NAME" "$FEATURE_DESC" > feature_output.json
          
          # Parse JSON output
          cat feature_output.json
          BRANCH_NAME=$(jq -r '.BRANCH_NAME' feature_output.json)
          SPEC_FILE=$(jq -r '.SPEC_FILE' feature_output.json)
          FEATURE_DIR=$(jq -r '.FEATURE_DIR' feature_output.json)
          
          # Use multiline output format for long paths
          {
            echo "branch_name=$BRANCH_NAME"
            echo "spec_file<<EOF"
            echo "$SPEC_FILE"
            echo "EOF"
            echo "feature_dir=$FEATURE_DIR"
          } >> $GITHUB_OUTPUT
          
          echo ""
          echo "‚úÖ Feature scaffolding created:"
          echo "  Branch: $BRANCH_NAME"
          echo "  Spec file: $SPEC_FILE"
          echo "  Feature dir: $FEATURE_DIR"
      
      - name: Step 3-6 - Generate Specification with Copilot
        env:
          GITHUB_TOKEN: ${{ secrets.COPILOT_TOKEN || secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.COPILOT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          export GITHUB_TOKEN="${GITHUB_TOKEN}"
          export GH_TOKEN="${GH_TOKEN}"
          export PATH="$HOME/.local/bin:$HOME/.cargo/bin:$PATH"
          
          SPEC_FILE="${{ steps.create_feature.outputs.spec_file }}"
          FEATURE_DESC="${{ github.event.inputs.feature_description }}"
          
          echo "üìù Step 3-6: Generating specification with Copilot..."
          echo ""
          
          # Generate spec with Copilot - using template and detailed instructions
          cat .specify/templates/spec-template.md > spec_context.txt
          echo -e "\n---\n" >> spec_context.txt
          echo "FEATURE DESCRIPTION: $FEATURE_DESC" >> spec_context.txt
          echo "" >> spec_context.txt
          echo "INSTRUCTIONS:" >> spec_context.txt
          echo "1. Write a complete feature specification following the template above" >> spec_context.txt
          echo "2. Focus on WHAT users need and WHY (not HOW to implement)" >> spec_context.txt
          echo "3. Make requirements testable and unambiguous" >> spec_context.txt
          echo "4. Define measurable, technology-agnostic success criteria" >> spec_context.txt
          echo "" >> spec_context.txt
          echo "CRITICAL: For unclear aspects, use [NEEDS CLARIFICATION: specific question]" >> spec_context.txt
          echo "- DO NOT make assumptions about:" >> spec_context.txt
          echo "  * Feature scope and boundaries (what's included/excluded)" >> spec_context.txt
          echo "  * User types and permissions (if multiple interpretations possible)" >> spec_context.txt
          echo "  * Security/privacy requirements (when legally/financially significant)" >> spec_context.txt
          echo "  * Data retention, integration points, or critical business rules" >> spec_context.txt
          echo "- ONLY make reasonable assumptions for:" >> spec_context.txt
          echo "  * Standard error handling patterns" >> spec_context.txt
          echo "  * Industry-standard performance expectations" >> spec_context.txt
          echo "  * Common UI/UX patterns" >> spec_context.txt
          echo "" >> spec_context.txt
          echo "Output the specification in markdown format, ready to save to a file." >> spec_context.txt
          
          npx @github/copilot --allow-all-tools --allow-all-paths -p "$(cat spec_context.txt)" 2>&1 | tee spec_output.txt
          
          # Copilot with --allow-all-tools may create files directly
          # Check if it created a spec file in specs/ directory
          CREATED_SPEC=$(find specs/ -name "*.md" -type f ! -path "*/[0-9][0-9][0-9]-*/*" 2>/dev/null | head -1)
          
          if [ -n "$CREATED_SPEC" ] && [ -f "$CREATED_SPEC" ]; then
            echo "‚úÖ Copilot created file: $CREATED_SPEC"
            echo "üìã Copying to: $SPEC_FILE"
            cp "$CREATED_SPEC" "$SPEC_FILE"
            # Clean up the original file
            rm "$CREATED_SPEC"
          else
            echo "‚ö†Ô∏è Copilot didn't create file directly, extracting from output..."
            # Extract markdown from output
            if grep -q "<< 'EOF'" spec_output.txt; then
              sed -n "/cat > .* << 'EOF'/,/^EOF$/p" spec_output.txt | sed '1d;$d' > "$SPEC_FILE"
            else
              sed -n '/^# /,${/Total usage/q;p}' spec_output.txt > "$SPEC_FILE"
            fi
          fi
          
          echo ""
          echo "‚úÖ Specification saved to: $SPEC_FILE"
          echo ""
          echo "Preview (first 30 lines):"
          head -30 "$SPEC_FILE"
      
      - name: Step 6 - Create Quality Checklist
        run: |
          SPEC_FILE="${{ steps.create_feature.outputs.spec_file }}"
          BRANCH_NAME="${{ steps.create_feature.outputs.branch_name }}"
          FEATURE_DESC="${{ github.event.inputs.feature_description }}"
          
          # Extract feature directory from spec file path
          SPEC_DIR=$(dirname "$SPEC_FILE")
          CHECKLIST_DIR="$SPEC_DIR/checklists"
          CHECKLIST_FILE="$CHECKLIST_DIR/requirements.md"
          
          echo "üìã Step 6: Creating quality checklist..."
          echo "Checklist will be created at: $CHECKLIST_FILE"
          
          # Create checklists directory
          mkdir -p "$CHECKLIST_DIR"
          
          # Extract feature name from spec
          FEATURE_NAME=$(grep "^# Feature Specification:" "$SPEC_FILE" | sed 's/# Feature Specification: //' || echo "Feature")
          
          # Count [NEEDS CLARIFICATION] markers in spec
          CLARIFICATION_COUNT=$(grep -c "\[NEEDS CLARIFICATION" "$SPEC_FILE" || echo "0")
          
          # Create checklist with template
          cat > "$CHECKLIST_FILE" << 'CHECKLIST_EOF'
# Specification Quality Checklist: ${FEATURE_NAME}

**Purpose**: Validate specification completeness and quality before proceeding to planning  
**Created**: $(date +%Y-%m-%d)  
**Feature**: [../spec.md](../spec.md)

## Content Quality

- [ ] No implementation details (languages, frameworks, APIs)
- [ ] Focused on user value and business needs
- [ ] Written for non-technical stakeholders
- [ ] All mandatory sections completed

## Requirement Completeness

- [ ] No [NEEDS CLARIFICATION] markers remain
- [ ] Requirements are testable and unambiguous
- [ ] Success criteria are measurable
- [ ] Success criteria are technology-agnostic (no implementation details)
- [ ] All acceptance scenarios are defined
- [ ] Edge cases are identified
- [ ] Scope is clearly bounded
- [ ] Dependencies and assumptions identified

## Feature Readiness

- [ ] All functional requirements have clear acceptance criteria
- [ ] User scenarios cover primary flows
- [ ] Feature meets measurable outcomes defined in Success Criteria
- [ ] No implementation details leak into specification

## Clarifications Needed

CHECKLIST_EOF
          
          # Substitute variables in checklist
          sed -i '' "s/\${FEATURE_NAME}/$FEATURE_NAME/g" "$CHECKLIST_FILE"
          
          # Add clarifications section
          if [ "$CLARIFICATION_COUNT" -gt 0 ]; then
            echo "" >> "$CHECKLIST_FILE"
            echo "‚ö†Ô∏è **$CLARIFICATION_COUNT clarification(s) found in specification**" >> "$CHECKLIST_FILE"
            echo "" >> "$CHECKLIST_FILE"
            echo "The following items need clarification:" >> "$CHECKLIST_FILE"
            echo "" >> "$CHECKLIST_FILE"
            
            # Extract all NEEDS CLARIFICATION markers with context
            grep -n "\[NEEDS CLARIFICATION" "$SPEC_FILE" | while IFS=: read -r line_num content; do
              # Extract the clarification text
              clarification=$(echo "$content" | sed 's/.*\[NEEDS CLARIFICATION: \(.*\)\].*/\1/')
              echo "- **Line $line_num**: $clarification" >> "$CHECKLIST_FILE"
            done
            
            echo "" >> "$CHECKLIST_FILE"
            echo "**Action Required**: Address these clarifications before proceeding to \`/speckit.plan\`" >> "$CHECKLIST_FILE"
          else
            echo "" >> "$CHECKLIST_FILE"
            echo "‚úÖ **No clarifications needed** - specification is complete and ready for planning" >> "$CHECKLIST_FILE"
          fi
          
          # Add notes section
          cat >> "$CHECKLIST_FILE" << 'NOTES_EOF'

## Validation Notes

*This checklist was auto-generated. Review each item and check off as validated.*

### Next Steps

1. Review specification for completeness
2. Address any clarifications marked above
3. Check off all validation items
4. Proceed to `/speckit.plan` when ready
NOTES_EOF
          
          echo ""
          echo "‚úÖ Checklist created at: $CHECKLIST_FILE"
          echo ""
          echo "Preview:"
          head -50 "$CHECKLIST_FILE"
      
      - name: Step 7 - Commit and Push Specification
        if: github.event.inputs.create_branch == 'true'
        run: |
          BRANCH_NAME="${{ steps.create_feature.outputs.branch_name }}"
          SPEC_FILE="${{ steps.create_feature.outputs.spec_file }}"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          echo "üì§ Step 7: Committing and pushing specification..."
          echo "Branch: $BRANCH_NAME"
          echo "Spec file: $SPEC_FILE"
          echo ""
          
          # Add all generated files
          git add -A
          
          if git diff --staged --quiet; then
            echo "‚ö†Ô∏è No changes to commit"
          else
            echo "üíæ Committing specification..."
            git commit -m "feat: add feature specification" \
              -m "Feature: ${{ github.event.inputs.feature_description }}" \
              -m "Generated by /speckit.specify workflow" \
              -m "Spec file: $SPEC_FILE"
            
            echo "üì§ Pushing to branch: $BRANCH_NAME"
            git push -f origin "$BRANCH_NAME"
            
            echo "‚úÖ Specification committed and pushed to $BRANCH_NAME"
          fi
      
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: spec-kit-output
          path: |
            short_name_output.txt
            feature_output.json
            spec_prompt.txt
            spec_output.txt
            ${{ steps.create_feature.outputs.feature_dir }}
          retention-days: 30
      
      - name: Summary
        if: always()
        run: |
          BRANCH_NAME="${{ steps.create_feature.outputs.branch_name }}"
          SPEC_FILE="${{ steps.create_feature.outputs.spec_file }}"
          FEATURE_DIR="${{ steps.create_feature.outputs.feature_dir }}"
          SHORT_NAME="${{ steps.generate_name.outputs.short_name }}"
          
          echo "## üìã Spec Kit - Specify Feature" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Feature:** ${{ github.event.inputs.feature_description }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Short Name:** \`$SHORT_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`$BRANCH_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Spec File:** \`$SPEC_FILE\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Feature Directory:** \`$FEATURE_DIR\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ‚úÖ Completed Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. ‚úÖ Generated short branch name using Copilot" >> $GITHUB_STEP_SUMMARY
          echo "2. ‚úÖ Created feature scaffolding with \`create-new-feature.sh\`" >> $GITHUB_STEP_SUMMARY
          echo "3. ‚úÖ Generated specification using Copilot + spec template" >> $GITHUB_STEP_SUMMARY
          echo "4. ‚úÖ Committed and pushed to feature branch" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìñ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the generated specification in the feature branch" >> $GITHUB_STEP_SUMMARY
          echo "2. Run \`/speckit.clarify\` if there are [NEEDS CLARIFICATION] markers" >> $GITHUB_STEP_SUMMARY
          echo "3. Run \`/speckit.plan\` to create technical implementation plan" >> $GITHUB_STEP_SUMMARY
          echo "4. Run \`/speckit.tasks\` to generate actionable task lists" >> $GITHUB_STEP_SUMMARY
          echo "5. Run \`/speckit.implement\` to execute all tasks" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîó Resources" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [View Branch](https://github.com/${{ github.repository }}/tree/$BRANCH_NAME)" >> $GITHUB_STEP_SUMMARY
          echo "- [View Spec](https://github.com/${{ github.repository }}/blob/$BRANCH_NAME/$SPEC_FILE)" >> $GITHUB_STEP_SUMMARY
          echo "- [Spec Kit Documentation](https://github.github.io/spec-kit/)" >> $GITHUB_STEP_SUMMARY

