name: AI-Assisted Code Review
on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Branch to analyze (default: main)'
        required: false
        default: 'main'
      prompt:
        description: 'Custom prompt for Copilot (optional)'
        required: false
        default: 'Review this code for bugs, security issues, and suggest improvements'

jobs:
  copilot-review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
      
      - name: Install Copilot CLI
        run: npm install -g @github/copilot
      
      - name: Authenticate GitHub CLI
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo $GITHUB_TOKEN | gh auth login --with-token
          gh auth status
      
      - name: Get code changes
        run: |
          echo "Analyzing changes from ${{ github.event.inputs.target_branch || 'main' }} to current branch..."
          git diff origin/${{ github.event.inputs.target_branch || 'main' }}...HEAD > code_diff.txt || {
            echo "No diff available, analyzing recent files instead..."
            find . -name "*.js" -o -name "*.ts" -o -name "*.py" | head -5 | xargs cat > code_diff.txt
          }
          echo "Code to analyze:"
          cat code_diff.txt
      
      - name: Test Copilot CLI
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "# GitHub Copilot CLI Test Results" > copilot_output.md
          echo "" >> copilot_output.md
          echo "## Prompt Used:" >> copilot_output.md
          echo "${{ github.event.inputs.prompt || 'Review this code for bugs, security issues, and suggest improvements' }}" >> copilot_output.md
          echo "" >> copilot_output.md
          echo "## Analysis:" >> copilot_output.md
          
          # Test different Copilot CLI commands
          echo "Testing npx @github/copilot explain..." >> copilot_output.md
          npx @github/copilot explain "$(cat code_diff.txt)" >> copilot_output.md 2>&1 || {
            echo "explain command failed, trying suggest..." >> copilot_output.md
            npx @github/copilot suggest "$(cat code_diff.txt)" >> copilot_output.md 2>&1 || {
              echo "suggest command failed, trying basic help..." >> copilot_output.md
              npx @github/copilot --help >> copilot_output.md 2>&1 || {
                echo "All Copilot CLI commands failed. Package info:" >> copilot_output.md
                npm list -g @github/copilot >> copilot_output.md 2>&1
                echo "Available commands:" >> copilot_output.md
                ls /usr/local/lib/node_modules/@github/copilot/bin/ >> copilot_output.md 2>&1 || echo "Cannot list copilot bin directory" >> copilot_output.md
              }
            }
          }
      
      - name: Show results
        run: |
          echo "=== COPILOT CLI TEST RESULTS ==="
          cat copilot_output.md
      
      - name: Upload results as artifact
        uses: actions/upload-artifact@v4
        with:
          name: copilot-analysis-results
          path: copilot_output.md