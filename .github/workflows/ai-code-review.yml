name: AI-Assisted Code Review
on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Branch to analyze (default: main)'
        required: false
        default: 'main'
      prompt:
        description: 'Custom prompt for Copilot (optional)'
        required: false
        default: 'Review this code for bugs, security issues, and suggest improvements'

jobs:
  copilot-review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
      
      - name: Install Copilot CLI and MCP Server
        run: |
          echo "Installing GitHub Copilot CLI..."
          npm install -g @github/copilot
          
          echo "Cloning Microsoft Docs MCP Server from GitHub..."
          git clone https://github.com/MicrosoftDocs/mcp.git /tmp/mcp-microsoft-docs
          cd /tmp/mcp-microsoft-docs
          npm install
          npm run build || echo "Build step not required"
      
      - name: Setup MCP Configuration
        run: |
          echo "Setting up MCP configuration for Copilot CLI..."
          mkdir -p ~/.copilot
          
          cat > ~/.copilot/mcp-config.json << 'EOF'
          {
            "mcpServers": {
              "microsoft-docs": {
                "command": "node",
                "args": ["/tmp/mcp-microsoft-docs/build/index.js"],
                "env": {}
              }
            }
          }
          EOF
          
          echo "MCP Config created:"
          cat ~/.copilot/mcp-config.json
      
      - name: Authenticate GitHub CLI
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "GitHub CLI authentication check..."
          gh auth status || echo "Auth status check failed but continuing..."
      
      - name: Get code changes
        run: |
          echo "Analyzing changes from ${{ github.event.inputs.target_branch || 'main' }} to current branch..."
          git diff origin/${{ github.event.inputs.target_branch || 'main' }}...HEAD > code_diff.txt || {
            echo "No diff available, analyzing recent files instead..."
            find . -name "*.js" -o -name "*.ts" -o -name "*.py" | head -5 | xargs cat > code_diff.txt
          }
          echo "Code to analyze:"
          cat code_diff.txt
      
      - name: Test Copilot CLI with Microsoft Docs MCP
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== Testing GitHub Copilot CLI with Microsoft Docs MCP ===" | tee copilot_output.md
          echo "" | tee -a copilot_output.md
          
          echo "## Test 1: Simple Microsoft Stack Query" | tee -a copilot_output.md
          echo "Query: What are the best practices for Azure Functions in Node.js?" | tee -a copilot_output.md
          echo "" | tee -a copilot_output.md
          
          npx @github/copilot \
            --allow-all-tools \
            --allow-all-paths \
            -p "Search Microsoft documentation and tell me the best practices for Azure Functions in Node.js. Include code examples if available." \
            2>&1 | tee -a copilot_output.md || echo "Query 1 failed" | tee -a copilot_output.md
          
          echo "" | tee -a copilot_output.md
          echo "---" | tee -a copilot_output.md
          echo "" | tee -a copilot_output.md
          
          echo "## Test 2: Code Analysis with Microsoft Stack Context" | tee -a copilot_output.md
          echo "Analyzing code changes in context of Microsoft technologies..." | tee -a copilot_output.md
          echo "" | tee -a copilot_output.md
          
          if [ -s code_diff.txt ]; then
            npx @github/copilot \
              --allow-all-tools \
              --allow-all-paths \
              -p "Review this code and check Microsoft documentation for any relevant best practices or issues. Code to review: $(cat code_diff.txt | head -100)" \
              2>&1 | tee -a copilot_output.md || echo "Query 2 failed" | tee -a copilot_output.md
          else
            echo "No code changes to analyze" | tee -a copilot_output.md
          fi
          
          echo "" | tee -a copilot_output.md
          echo "---" | tee -a copilot_output.md
          echo "" | tee -a copilot_output.md
          
          echo "## Test 3: MCP Server Verification" | tee -a copilot_output.md
          echo "Checking if MCP server is accessible..." | tee -a copilot_output.md
          echo "" | tee -a copilot_output.md
          
          npx @github/copilot \
            --allow-all-tools \
            -p "List available MCP tools and confirm microsoft-docs server is working" \
            2>&1 | tee -a copilot_output.md || echo "MCP check failed" | tee -a copilot_output.md
      
      - name: Show results
        run: |
          echo "=== COPILOT CLI TEST RESULTS ==="
          cat copilot_output.md
      
      - name: Upload results as artifact
        uses: actions/upload-artifact@v4
        with:
          name: copilot-analysis-results
          path: copilot_output.md