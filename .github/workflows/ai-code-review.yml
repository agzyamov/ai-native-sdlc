name: AI-Assisted Code Review
on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Branch to analyze (default: main)'
        required: false
        default: 'main'
      prompt:
        description: 'Custom prompt for Copilot (optional)'
        required: false
        default: 'Review this code for bugs, security issues, and suggest improvements'

jobs:
  copilot-review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
      
      - name: Install Copilot CLI
        run: npm install -g @github/copilot
      
      - name: Authenticate GitHub CLI
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "GitHub CLI authentication check..."
          gh auth status || echo "Auth status check failed but continuing..."
      
      - name: Get code changes
        run: |
          echo "Analyzing changes from ${{ github.event.inputs.target_branch || 'main' }} to current branch..."
          git diff origin/${{ github.event.inputs.target_branch || 'main' }}...HEAD > code_diff.txt || {
            echo "No diff available, analyzing recent files instead..."
            find . -name "*.js" -o -name "*.ts" -o -name "*.py" | head -5 | xargs cat > code_diff.txt
          }
          echo "Code to analyze:"
          cat code_diff.txt
      
      - name: Test Copilot CLI
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== Testing GitHub Copilot CLI ==="
          echo ""
          
          echo "1. Checking npm package installation..."
          npm list -g @github/copilot || echo "Package not found in global list"
          echo ""
          
          echo "2. Checking package location..."
          npm root -g
          ls -la $(npm root -g)/@github/ || echo "No @github directory"
          echo ""
          
          echo "3. Trying to run copilot with npx..."
          npx @github/copilot --version 2>&1 || echo "Version command failed"
          echo ""
          
          echo "4. Checking available scripts in package.json..."
          cat $(npm root -g)/@github/copilot/package.json 2>&1 | grep -A 10 '"bin"' || echo "Cannot find bin section"
          echo ""
          
          echo "5. Trying help command..."
          npx @github/copilot --help 2>&1 || echo "Help command failed"
          echo ""
          
          echo "6. Listing executables..."
          find $(npm root -g)/@github/copilot -type f -name "*.js" -o -name "copilot*" 2>&1 | head -20
          echo ""
          
          echo "=== Test Complete ===" > copilot_output.md
          echo "Check logs above for details" >> copilot_output.md
      
      - name: Show results
        run: |
          echo "=== COPILOT CLI TEST RESULTS ==="
          cat copilot_output.md
      
      - name: Upload results as artifact
        uses: actions/upload-artifact@v4
        with:
          name: copilot-analysis-results
          path: copilot_output.md