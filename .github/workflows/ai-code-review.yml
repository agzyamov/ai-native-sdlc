name: AI-Assisted Code Review
on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Branch to analyze (default: main)'
        required: false
        default: 'main'
      prompt:
        description: 'Custom prompt for Copilot (optional)'
        required: false
        default: 'Review this code for bugs, security issues, and suggest improvements'

jobs:
  copilot-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
      
      - name: Install Copilot CLI
        run: |
          echo "Installing GitHub Copilot CLI..."
          npm install -g @github/copilot
      
      - name: Setup MCP Configuration
        run: |
          echo "Setting up MCP configuration for Copilot CLI..."
          mkdir -p ~/.copilot
          
          cat > ~/.copilot/mcp-config.json << 'EOF'
          {
            "mcpServers": {
              "microsoft-docs": {
                "type": "http",
                "url": "https://learn.microsoft.com/api/mcp"
              }
            }
          }
          EOF
          
          echo "MCP Config created:"
          cat ~/.copilot/mcp-config.json
      
      - name: Authenticate GitHub CLI
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "GitHub CLI authentication check..."
          gh auth status || echo "Auth status check failed but continuing..."
      
      - name: Get code changes
        run: |
          echo "Analyzing changes from ${{ github.event.inputs.target_branch || 'main' }} to current branch..."
          git diff origin/${{ github.event.inputs.target_branch || 'main' }}...HEAD > code_diff.txt || {
            echo "No diff available, analyzing recent files instead..."
            find . -name "*.js" -o -name "*.ts" -o -name "*.py" | head -5 | xargs cat > code_diff.txt
          }
          echo "Code to analyze:"
          cat code_diff.txt
      
      - name: Test Copilot CLI with Microsoft Docs MCP
        env:
          GITHUB_TOKEN: ${{ secrets.COPILOT_TOKEN || secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.COPILOT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          # Export token for copilot
          export GITHUB_TOKEN="${GITHUB_TOKEN}"
          export GH_TOKEN="${GH_TOKEN}"
          
          echo "=== Testing GitHub Copilot CLI with Microsoft Docs MCP ===" | tee copilot_output.md
          echo "" | tee -a copilot_output.md
          
          # Check if we have proper authentication
          if [ -z "$GITHUB_TOKEN" ]; then
            echo "âŒ ERROR: No COPILOT_TOKEN secret found!" | tee -a copilot_output.md
            echo "Please add a Personal Access Token with Copilot permissions as COPILOT_TOKEN secret" | tee -a copilot_output.md
            exit 1
          fi
          
          echo "## Test 1: Simple Microsoft Stack Query" | tee -a copilot_output.md
          echo "Query: What are the best practices for Azure Functions in Node.js?" | tee -a copilot_output.md
          echo "" | tee -a copilot_output.md
          
          GITHUB_TOKEN="${GITHUB_TOKEN}" GH_TOKEN="${GH_TOKEN}" npx @github/copilot \
            --allow-all-tools \
            --allow-all-paths \
            -p "Use the microsoft_docs_search MCP tool to search for Azure Functions Node.js best practices. Then use microsoft_code_sample_search to find code examples. Provide a comprehensive answer with official documentation references." \
            2>&1 | tee -a copilot_output.md || echo "Query 1 failed" | tee -a copilot_output.md
          
          echo "" | tee -a copilot_output.md
          echo "---" | tee -a copilot_output.md
          echo "" | tee -a copilot_output.md
          
          echo "## Test 2: Code Analysis with Microsoft Stack Context" | tee -a copilot_output.md
          echo "Analyzing code changes in context of Microsoft technologies..." | tee -a copilot_output.md
          echo "" | tee -a copilot_output.md
          
          if [ -s code_diff.txt ]; then
            GITHUB_TOKEN="${GITHUB_TOKEN}" GH_TOKEN="${GH_TOKEN}" npx @github/copilot \
              --allow-all-tools \
              --allow-all-paths \
              -p "Use microsoft_docs_search MCP tool to check Microsoft documentation for best practices related to this code. Then provide a code review with official documentation references. Code to review: $(cat code_diff.txt | head -100)" \
              2>&1 | tee -a copilot_output.md || echo "Query 2 failed" | tee -a copilot_output.md
          else
            echo "No code changes to analyze" | tee -a copilot_output.md
          fi
          
          echo "" | tee -a copilot_output.md
          echo "---" | tee -a copilot_output.md
          echo "" | tee -a copilot_output.md
          
          echo "## Test 3: MCP Server Verification" | tee -a copilot_output.md
          echo "Checking if MCP server is accessible..." | tee -a copilot_output.md
          echo "" | tee -a copilot_output.md
          
          GITHUB_TOKEN="${GITHUB_TOKEN}" GH_TOKEN="${GH_TOKEN}" npx @github/copilot \
            --allow-all-tools \
            -p "List available MCP tools and confirm microsoft-docs server is working" \
            2>&1 | tee -a copilot_output.md || echo "MCP check failed" | tee -a copilot_output.md
      
      - name: Show results
        run: |
          echo "=== COPILOT CLI TEST RESULTS ==="
          cat copilot_output.md
      
      - name: Upload results as artifact
        uses: actions/upload-artifact@v4
        with:
          name: copilot-analysis-results
          path: copilot_output.md