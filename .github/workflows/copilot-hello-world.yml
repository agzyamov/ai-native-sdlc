name: Copilot Hello World Generator

on:
  workflow_dispatch:

jobs:
  generate-hello-world:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
      
      - name: Install Copilot CLI
        run: |
          npm install -g @github/copilot
          npx @github/copilot --version
      
      - name: Generate Hello World with Copilot
        env:
          GITHUB_TOKEN: ${{ secrets.COPILOT_TOKEN || secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.COPILOT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          export GITHUB_TOKEN="${GITHUB_TOKEN}"
          export GH_TOKEN="${GH_TOKEN}"
          
          echo "Asking Copilot to write Hello World in Python..."
          
          # Get code from Copilot
          GITHUB_TOKEN="${GITHUB_TOKEN}" GH_TOKEN="${GH_TOKEN}" npx @github/copilot \
            --allow-all-tools \
            -p "Write a simple Python Hello World program. Output ONLY the code without any explanations or markdown. Just pure Python code." \
            > copilot_output.txt 2>&1
          
          echo ""
          echo "=== Copilot Response ==="
          cat copilot_output.txt
      
      - name: Extract and Save Code
        run: |
          # Try to find Python code in the output
          if grep -q "print" copilot_output.txt; then
            # Extract lines that look like Python code
            grep -E "^(print|#|def |import |if |for |while )" copilot_output.txt > hello.py || true
            
            # If empty, try to extract from code blocks
            if [ ! -s hello.py ]; then
              sed -n '/```python/,/```/p' copilot_output.txt | sed '1d;$d' > hello.py || true
            fi
            
            # If still empty, try without language specifier
            if [ ! -s hello.py ]; then
              sed -n '/```/,/```/p' copilot_output.txt | sed '1d;$d' > hello.py || true
            fi
          fi
          
          # If we still don't have code, create a simple one
          if [ ! -s hello.py ]; then
            echo "No code extracted from Copilot, creating simple Hello World..."
            echo 'print("Hello, World!")' > hello.py
          fi
          
          echo ""
          echo "=== Generated hello.py ==="
          cat hello.py
          
          # Test the code
          echo ""
          echo "=== Testing Python code ==="
          python3 hello.py
      
      - name: Commit and Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add hello.py copilot_output.txt
          git commit -m "Add Copilot-generated Hello World"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Show Result
        run: |
          echo "âœ… Successfully generated and committed hello.py"
          echo ""
          echo "File content:"
          cat hello.py
